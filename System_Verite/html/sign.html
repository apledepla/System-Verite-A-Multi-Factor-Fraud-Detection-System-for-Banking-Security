<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>BPI | Security Verification</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style-wr.css') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='picture/bpi_logo.png') }}">
</head>

<body>

  <!-- Whole Container -->
  <div class="container">

    <!-- Sidebar Content (Red BG)-->
    <div class="progressbar"><div class="progress"></div></div>
    
    <form method="POST" action="/restart">
      <button id="reloadBtn" title="Start Over" style="position: absolute; top: 15px; right: 20px; background: none; border: none; cursor: pointer; font-size: 28px; transition: color 0.3s ease;">
        ↻
      </button>
    </form>
 
    <div class="sidebar">
      <img src="{{ url_for('static', filename='picture/bpi_logo_2.png') }}" alt="BPI Logo">
      <h2>Security Measures</h2>
      <ul class="steps">
        <li class="active" data-step="1">OTP Verification</li>
        <li class="active" data-step="2">Upload Signature</li>
        <li class="active" data-step="3">Face Detection</li>
        <li class="active" data-step="4">Final Verify</li>
      </ul>
    </div>
    
    <!-- Whole Form Content (White BG)-->
    <div class="form-content">

      <div class="form-step active">
        <h3>Final Verification</h3>
        <p>Take a picture together with your ID with signature for verification.</p>

        <div>
          <img src="{{ url_for('video_feed') }}" class="preview-img">

          <center>
            <form method="POST" action="/detect">
              <button class="btn" type="submit">Detect and Crop</button>
            </form>
          </center>
        </div>

        <div>
          {% if image_paths %}
            <h2>Picture Result:</h2>
            <img src="{{ url_for('static', filename='entire_pic.jpg') }}?v={{ timestamp | default(0) }}" class="preview-img">
        
            <center>
              
              <!-- Verify Button -->
              <form method="POST" action="/verify" id="verifyForm">
                <button type="submit" id="finalVerifyBtn" class="btn">Verify</button>
              </form>

              <!-- Loading Spinner -->
              <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Verifying, please wait...</p>
              </div>

              </center>

          {% endif %}
        </div>
        
        {% if similarity_score is defined %}
          <h3>Verification Result:</h3>
          
          <div style="margin-top: 10px;transform: translateX(20px);">  
            <p><strong>Match:</strong> {{ match }}</p>
          </div>

        {% elif result %}
          <p style="color: {% if '❌' in result %}red{% else %}green{% endif %}; font-weight:bold;">
            {{ result }}
          </p>
        
        {% endif %}

        {% if face_verification_match is defined %}
          <div style="transform: translateX(20px);">
            <p><strong>Face Verification Result:</strong> {{ face_verification_match }}</p>
            <p><strong>Face Verification Confidence:</strong> {{ face_verification_conf }}</p>
            <p><strong>Face Verification Distance:</strong> {{ face_verification_distance }}</p>
          </div>

          <form method="POST" action="/restart">
            <button class="btn" id="reloadBtn" type="submit">Start Over ↻</button>
          </form>
          {% elif result_face_verification %}
            <p>{{ result_face_verification }}</p>
          {% endif %}
        
      </div>

    </div>

  </div>

</body>

<script>

    const steps = document.querySelectorAll(".steps li");
    const formSteps = document.querySelectorAll(".form-step");
    const nextBtns = document.querySelectorAll(".next");
    const progress = document.querySelector(".progress");
    let currentStep = 4;

    document.getElementById("reloadBtn").addEventListener("click", () => {
      if (confirm("Are you sure you want to start over?")) {
        window.location.href = "/restart";
      }
    });


    function updateStep(n) {
      formSteps.forEach((step, i) => {
        step.classList.toggle("active", i === n);
        if (steps[i]) steps[i].classList.toggle("active", i <= n);
      });
      const percent = (n / (formSteps.length - 1)) * 100;
      if (progress) progress.style.width = percent + "%";
    }


    // Navigation
    nextBtns.forEach(btn => btn.addEventListener("click", () => { if (currentStep < formSteps.length - 1) { currentStep++; updateStep(currentStep); } }));
    prevBtns.forEach(btn => btn.addEventListener("click", () => { if (currentStep > 0) { currentStep--; updateStep(currentStep); } }));

    // Final Verify
    document.getElementById("verifyForm").addEventListener("submit", (e) => {
      document.getElementById("loading").style.display = "block";

      // Let the spinner show before form submits
      setTimeout(() => {
        e.target.submit();
      }, 1000); // 1000ms delay
      e.preventDefault();
    });

</script>

</html>