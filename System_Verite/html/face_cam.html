<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>BPI | Security Verification</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style-wr.css') }}">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='picture/bpi_logo.png') }}">
</head>

<body>

  <!-- Whole Container -->
  <div class="container">

    <!-- Sidebar Content (Red BG)-->
    <div class="progressbar"><div class="progress"></div></div>
    
    <form method="POST" action="/restart">
      <button id="reloadBtn" title="Start Over" style="position: absolute; top: 15px; right: 20px; background: none; border: none; cursor: pointer; font-size: 28px; transition: color 0.3s ease;">
        ↻
      </button>
    </form>
 
    <div class="sidebar">
      <img src="{{ url_for('static', filename='picture/bpi_logo_2.png') }}" alt="BPI Logo">
      <h2>Security Measures</h2>
      <ul class="steps">
        <li class="active" data-step="1">OTP Verification</li>
        <li class="active" data-step="2">Upload Signature</li>
        <li class="active" data-step="3">Face Detection</li>
        <li data-step="4">Final Verify</li>
      </ul>
    </div>

    <!-- Whole Form Content (White BG) -->
    <div class="form-content">

      <div class="form-step active">
        <h3>Live Face Detection</h3>
        <p>Make sure to take a picture that clearly shows your face.</p>
        
        <center>
          <!-- Button that opens the camera-->
          <button id="openCameraBtn" class="btn">Open Camera</button>

          <!--Hidden live feed (shown only after button click)-->
          <img id="liveFeed" class="preview-img" 
              src="{{ url_for('video_feed_face_detect') }}"
              style="display: none;">

          <!-- Capture button (hidden until camera is open)-->
          <div id = "capture_face" style="display:none">
            <button type="button" id="captureBtn" class="btn">Capture Photo</button>
          </div>

          <!-- Saved image preview-->
          <div id="savedFeed" class="show_image" style="display:none">
            <h4 style="margin-top: 10px;">Captured Photo:</h4>
            <img id="savedImage" src="" class="preview-img" style="display:none">

            <div style="display: flex; justify-content: center; gap: 12px; margin-top: 15px;">
        
              <!-- Retake button -->
              <button id="retakeBtn" class="btn" type="button" style="display:none">Retake</button>
            
              <!-- Next button only shown if a photo exists-->
              <form method="POST" action="/detect">
                <button id="nextBtn" class="btn" type="submit" style="display:none">Next →</button>
              </form>

            </div>
          </div>
        </center>

      </div>

    </div>

  </div>

</body>

<script>
    const steps = document.querySelectorAll(".steps li");
    const formSteps = document.querySelectorAll(".form-step");
    const nextBtns = document.querySelectorAll(".next");
    const progress = document.querySelector(".progress");
    let currentStep = 3;

    document.getElementById("reloadBtn").addEventListener("click", () => {
      if (confirm("Are you sure you want to start over?")) {
        window.location.href = "/restart";
      }
    });


    function updateStep(n) {
      formSteps.forEach((step, i) => {
        step.classList.toggle("active", i === n);
        if (steps[i]) steps[i].classList.toggle("active", i <= n);
      });
      const percent = (n / (formSteps.length - 1)) * 100;
      if (progress) progress.style.width = percent + "%";
    }



    // Open camera
    document.getElementById("openCameraBtn").addEventListener("click", () => {
      document.getElementById("openCameraBtn").style.display = "none"; // hide open button
      document.getElementById("liveFeed").style.display = "block";     // show live feed
      document.getElementById("capture_face").style.display = "block"; // show capture btn
      document.getElementById("savedFeed").style.display = "none";     // hide saved photo section
    });

    // Capture photo
    document.getElementById("captureBtn").addEventListener("click", async () => {
      try {
        const response = await fetch("/save_face_pic", { method: "POST" });
        const data = await response.json();

        alert(data.message);

        if (data.status === "success") {
          // Update captured photo
          const imgEl = document.getElementById("savedImage");
          imgEl.src = data.image_path + "?v=" + Date.now();
          imgEl.style.display = "block";

          // Show saved photo + Next + Retake
          document.getElementById("savedFeed").style.display = "block";
          document.getElementById("nextBtn").style.display = "inline-block";
          document.getElementById("retakeBtn").style.display = "inline-block";

          // Hide live feed + capture button
          document.getElementById("liveFeed").style.display = "none";
          document.getElementById("capture_face").style.display = "none";
        }
      } catch (err) {
        alert("An error occurred while saving the photo.");
      }
    });

    // Retake photo
    document.getElementById("retakeBtn").addEventListener("click", () => {
      document.getElementById("savedFeed").style.display = "none";     // hide saved photo
      document.getElementById("nextBtn").style.display = "none";       // hide Next button
      document.getElementById("retakeBtn").style.display = "none";     // hide Retake

      // Show live feed again
      document.getElementById("liveFeed").style.display = "block";
      document.getElementById("capture_face").style.display = "block";
    });



    // Navigation
    nextBtns.forEach(btn => btn.addEventListener("click", () => { if (currentStep < formSteps.length - 1) { currentStep++; updateStep(currentStep); } }));
    prevBtns.forEach(btn => btn.addEventListener("click", () => { if (currentStep > 0) { currentStep--; updateStep(currentStep); } }));

</script>

</html>